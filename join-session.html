<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Session - Coragem</title>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
<div class="container">
    <div class="header">
        <button class="back-button" id="back-button">
            ‚Üê Go Back
        </button>
        <i class="fa-regular fa-sun sun-icon"></i>
    </div>

    <div class="main-content">
        <div class="title-container">
            <div class="welcome-text">Joining</div>
            <div class="logo">session</div>
        </div>

        <div class="form-container">
            <div class="error-message" id="error-message">Please fill in all fields</div>
            <input type="text" id="name-field" class="input-field" placeholder="Name">
            <input type="text" id="session-code-field" class="input-field" placeholder="Session Code">
            <button class="join-button" id="join-button">Join</button>

            <div class="status" id="status">Connecting to server...</div>
        </div>
    </div>
</div>

<script src="js/join-session.js"></script>
<script>
    let peer;
    const status = document.getElementById('status');
    const roomNameInput = document.getElementById('session-code-field');
    const userNameInput = document.getElementById('name-field');
    const joinBtn = document.getElementById('join-button');

    function initializePeer() {
        peer = new Peer({
            config: {
                iceServers: [
                    {
                        urls: "stun:stun.relay.metered.ca:80",
                    },
                    {
                        urls: "turn:global.relay.metered.ca:80",
                        username: "c6b847e6b1529929d92031ed",
                        credential: "ax783OE1j1gGpLL5",
                    },
                    {
                        urls: "turn:global.relay.metered.ca:80?transport=tcp",
                        username: "c6b847e6b1529929d92031ed",
                        credential: "ax783OE1j1gGpLL5",
                    },
                    {
                        urls: "turn:global.relay.metered.ca:443",
                        username: "c6b847e6b1529929d92031ed",
                        credential: "ax783OE1j1gGpLL5",
                    },
                    {
                        urls: "turns:global.relay.metered.ca:443?transport=tcp",
                        username: "c6b847e6b1529929d92031ed",
                        credential: "ax783OE1j1gGpLL5",
                    },
                ],
            }
        });

        peer.on('open', (id) => {
            status.textContent = 'Connected to server';
            status.classList.remove('error');
            joinBtn.disabled = false;
        });

        peer.on('error', (err) => {
            console.error('PeerJS error:', err);
            status.textContent = `Error: ${err.type} - ${err.message}`;
            status.classList.add('error');
        });
    }

    joinBtn.addEventListener('click', () => {
        const roomName = roomNameInput.value.trim();
        const userName = userNameInput.value.trim() || `User_${Math.random().toString(36).substr(2, 6)}`;

        if (!roomName) {
            status.textContent = 'Please enter a session code to join';
            status.classList.add('error');
            return;
        }

        // Store room info in sessionStorage
        sessionStorage.setItem('roomName', roomName);
        sessionStorage.setItem('userName', userName);
        sessionStorage.setItem('peerId', peer.id);
        sessionStorage.setItem('isHost', 'false');

        // Redirect to chat room
        window.location.href = 'test/chat-room.html'; // TODO CHANGE THE PATH
    });

    initializePeer();
</script>
</body>
</html>
